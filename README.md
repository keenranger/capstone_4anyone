# Capstone 4anyone : automatic shifting bicycle
## 설명
두개의 홀 센서 / 두개의 서보모터(MG996R)가 각각 배터리, 하우징에 있는 아두이노 우노 보드에 연결되어 있어, 두개의 홀 센서에서 받은 신호로 자전거의 케이던스와 속도 정보를 얻습니다. 케이던스, 속도(케이던스와 바퀴의 직경으로 계산된 수치) 정보를 바탕으로 아두이노가 두 개의 서보모터를 제어하여 자전거 기어 변속을 실행하는 방식입니다. 자전거 기어 변속은 일정한 페달링(일정한 케이던스, 평균 90RPM)을 유지하기 위해 실시됩니다. 아두이노 와 서보모터, 센서 등의 전원은 자체제작 배터리로 공급할 예정입니다. (6V, 10000mah 정도 예상)  

두개의 홀 센서는 페달과 자전거 뒷바퀴에 각각 설치되어 페달링rpm 과 뒷바퀴의 속도를 측정합니다. (외부 인터럽트를 사용하여 빈도수를 측정하기에 아두이노의 2번핀과 3번핀을 사용합니다)

두개의 서보모터는 각각 앞쪽 드레일러와 뒤쪽 드레일러에 장착되어 아두이노에 내장된 알고리즘에 따라 각회전을 하여 앞쪽 드레일러와 뒤쪽 드레일러의 위치를 움직입니다. 신호선용으로 핀 두개 사용합니다. 

자전거의 핸들 중앙에는 LCD 패널이 장착되어 있어, 케이던스, 주행속도, 현재 기어단수, 이동한 거리, (배터리 잔량) 등의 정보를 화면에 표시합니다. 핸들 오른쪽에는 손으로 조작할 수 있는 버튼이 있습니다. 자전거 주행모드의 변환용(수동<->자동), 기어를 올리고 내리는데 쓰이는 용으로 3개 정도 생각하고 있습니다. (아래의 그림을 참고해주세요)
 
 ![shifting_nums](./docs/images/shifting_nums.png)
 
앞기어는 3단으로 구성되어 있다(28T, 34T, 44T)
뒷기어는 7단으로 구성되어 있다(14T, 16T, 18T, 21T, 24T, 28T, 32T)
그중 자동변속기능에 사용하는 조합은 다음과 같다  


# Gear Ratio

## Gear Selection
|Gear|Front Gear|Rear gear|
|------|---|---|
|**<span style="color:green">L 1**|28T|32T|
|**<span style="color:green">L 2**|28T|28T|
|A 1|28T|24T|
|A 2|28T|21T|
|A 3|34T|21T|
|A 4|34T|18T|
|A 5|34T|16T|
|A 6|44T|18T|
|**<span style="color:red">H 1**|44T|16T|
|**<span style="color:red">H 2**|44T|14T|

## Front Gear
|Teeth|Degree|백래쉬(상승)|백래쉬(하강)|
|---|---|---|---|
|28T|100|-|100|
|34T|72|68|76|
|44T|58|54|-|

## Rear Gear
|Teeth|Degree|
|---|---|
|32T|145|
|28T|121|
|24T|98|
|21T|85|
|18T|73(up),77(down)
|16T|65|
|14T|47|  











컨트롤러와 배터리는 자전거 프레임의 중앙에 둘 계획이고, 그에 맞는 하우징을 만들 계획입니다. 배터리는 3.7V(완충시 4.2V) 전지 3개를 병렬 연결하여 자체제작 할 예정입니다. 승압보드를 이용해서 6V로 올릴 것이고, usb-c type 충전이 가능합니다. 용량은 10000mah 정도 입니다. 서보의 작동전압은 4.8V ~ 7.2V, 작동시 500-900mA의 전류를 소모합니다. (실제 확인했을 때 대기전력 50mA, 사용전력 1~200mA로 측정되었습니다.) 컨트롤러는 연결의 편의성을 위해 아두이노 나노를 사용합니다. 

*사용자가 배터리 잔량을 LCD로 확인할 수 있게 하려고 하는데 이부분에 대해서 자문을 구합니다. 
*케이던스와 속도측정하는 코딩은 만들어서 첨부합니다. 여기에 아래의 기본동작 관련 코딩 추가까지가 저희가 원하는 부분입니다! (아래 기본동작 코딩과 같이 병합되기 위해서 코드의 수정이 필요할 수도 있습니다).

전원을 켰을 때 기본적인 동작은
⦁	변수(이전 기어셋팅) 및 버튼체크 (수동모드인지, 자동모드인지) – 자동모드가 default
⦁	각 기어 단마다 고유의 서보모터 각변위값이 있고, 기어 단 변경시 현재의 단을 파악한 뒤 위아래 단의 변위에 맞게 서보모터가 회전합니다.(회전운동을 선형운동으로 바꿔야해서 각 단마다 움직이는 각도가 다르기 때문)
⦁	수동모드일 경우 위아래 버튼으로 기어단수 수동조작 가능, LCD에는 status만 표시
3-1 Status에는 현재단수, 케이던스(페달링rpm), 현재속도, 배터리 잔량이 나오게 할 것.
⦁	자동모드일 경우 미리 조합된 6가지 기어 내에서 주행자의 케이던스에 따라 자동으로 주어진 알고리즘에 따라 기어변속이 이루어짐(위의 사진에 노란색으로 표시된 단)
4-1 우선 페달링 rpm이 90으로 유지될 수 있도록 코드를 짜고 그 이후에 아래 보이는 알고리즘 flowchart처럼 실험을 하면서 세부적으로 조정해 나갈 예정입니다.
4-2 속도를 낮추고 싶거나 자전거가 급히 정지하는 상황의 경우(두 경우 모두다 페달링이 없는상황)에는 기어가 한 단만 낮춰지도록 하려고 합니다. (자전거 체인의 특성상 페달링을 하지 않을 때 기어를 변경할 수 없음) (fig 2 의 왼쪽하단의 경우인데, 우리의 방식에선 속도를 체크 한 뒤 알맞은 단으로 가는 것이 아니라 한 단만 낮추는 것입니다)
4-3 속도를 올리고싶을때(페달링 RPM이 90초과)는 기어가 한단 올라갈 수 있게합니다.
4-4 특수한 단은 4가지가 있으며, 각각 위의 속도표에서 속도가 32.67km/h 이상으로 나오는 고단 2개와 속도가 11.88km/h 이하로 나오는 저단 2개입니다.
4-5 특수단 중 고단 2개는 높은 속력을 원하는 사용자를 위해 따로 빼둔 단이고, 자동모드이지만 이 2개의 단은 자동변속에 해당되지 않습니다. 하지만 자동변속을 이용중에 속도를 더 내고싶은 경우 위의 사진에 있는 스위치에 △에 해당되는 버튼을 누르면 고속주행 모드로 들어가서 High1(32.67km/h 이상), High2(37.30km/h 이상) 두가지 단을 수동으로 움직일 수 있게 됩니다. 이때 High1과 2 의 변환은 △▽ 로 조정하며, △▽ 버튼 중앙에 있는 원형 버튼을 누를 시, 자동모드의 기본6단계이용 상태로 돌아옵니다.
4-6 특수단 중 저단 2개는 극심한 경사로를 올라가기 위한 단입니다. 위와 마찬가지로 자동모드에 속해있지만 자동변속을 하지 않습니다. 자동변속을 이용중에 심한 오르막을 만나게 되서, 기존 자동모드에 속한 6단계중 1단만으로는 오르막을 오르기 힘들 때를 대비하여 만들어 놓은 단입니다. 마찬가지로 Low1(11.88km/h 이하), Low2(10.45km/h 이하) 의 두가지 단을 수동으로 움직일 수 있고,  Low1과 2 의 변환은 △▽ 로 조정하며, △▽ 버튼 중앙에 있는 원형 버튼을 누를 시, 자동모드의 기본6단계이용 상태로 돌아옵니다.
4-7 RPM이 90이 유지되는 경우는 속도와 기어를 유지하고 싶다고 판단하고 기어 변속이 이루어지지 않습니다.


*전원이 꺼졌다 켜져도 아두이노가 마지막 자전거 기어셋팅을 기억하고 있어야 합니다.
*측정결과 서보모터 자체의 백래쉬는 1~2도 사이입니다. 
*RPM을 90으로 정확하게 정해버리면 기어변속이 계속 일어나기 때문에 범위값(80~100)으로 설정합니다.
*배터리 부족 시 배터리 부족 알림이 올 수 있기를 희망합니다.
 
 ![bicycle_algorithm](./docs/images/bicycle_algorithm.png)  




# 참고 할 자료
[EEPROM 사용법](https://m.blog.naver.com/damtaja/220217759177)